#reloadable

import crafttweaker.util.IRandom;
import crafttweaker.event.PlayerTickEvent;
import scripts.libs.Vector3D;
import scripts.libs.Util;
import mods.zenutils.command.ZenCommand;
import mods.zenutils.command.CommandUtils;
import mods.zenutils.NetworkHandler;
import mods.randomtweaker.botania.IBotaniaFXHelper;
import mods.ctintegration.util.DateUtil;

function showImageByParticles(pixels as int[], width as int, height as int, color as int, random as IRandom, offset as double[]) as void {
    val angle as double[] = [random.nextDouble(-60, 60), 0.0, random.nextDouble(-60, 60)];
    val imageCenterUnit = Vector3D.eulaAng(Vector3D.VY, angle);
    val transformMat as double[][] = [Vector3D.eulaAng(Vector3D.VX, angle), Vector3D.eulaAng(Vector3D.VZ, angle), Vector3D.VY];
    val distance = random.nextDouble(10.0, 25.0);
    val size = distance * random.nextDouble(0.1, 0.5);
    val imageCenter = Vector3D.scale(imageCenterUnit, distance);
    val r = 1.0f * (color / 0x10000) / 255.0f;
    val g = 1.0f * ((color / 0x100) & 0xff) / 255.0f;
    val b = 1.0f * (color & 0xff) / 255.0f;
    for i in 0 .. pixels.length / 2 {
        val x = pixels[i * 2];
        val y = pixels[i * 2 + 1];
        val xUnit = (0.0 + x - width / 2) / width;
        val yUnit = (0.0 + y - height / 2) / height;
        val pixelTrans = Vector3D.rebase([xUnit, yUnit, 0], transformMat);
        val pixelPos = Vector3D.add(Vector3D.scale(pixelTrans, size), Vector3D.add(imageCenter, offset));
        IBotaniaFXHelper.wispFX(pixelPos[0], pixelPos[1], pixelPos[2], r, g, b, 0.1f, 0.0f, 10.0f);
    }
}

val popuko as int[] = [
    93, 43, 286, 43, 98, 44, 165, 44, 171, 44, 177, 44, 183, 44, 189, 44, 195, 44, 201, 44, 
    207, 44, 213, 44, 291, 44, 88, 45, 103, 45, 218, 45, 280, 45, 296, 45, 158, 46, 223, 46,
    107, 47, 152, 47, 228, 47, 284, 47, 84, 48, 147, 48, 233, 48, 277, 48, 300, 48, 63, 49,
    238, 49, 317, 49, 57, 50, 68, 50, 110, 50, 140, 50, 243, 50, 311, 50, 322, 50, 328, 50,
    74, 51, 248, 51, 274, 51, 50, 52, 79, 52, 134, 52, 302, 52, 332, 52, 252, 53, 308, 53,
    337, 53, 46, 54, 83, 54, 112, 54, 129, 54, 256, 55, 272, 55, 341, 55, 42, 56, 124, 56,
    261, 57, 303, 57, 345, 58, 38, 59, 84, 59, 113, 59, 119, 59, 265, 59, 72, 60, 78, 60,
    271, 60, 307, 60, 313, 60, 349, 60, 34, 61, 301, 61, 68, 62, 318, 62, 115, 63, 352, 63,
    31, 64, 85, 65, 272, 65, 299, 65, 64, 66, 320, 66, 356, 66, 27, 67, 276, 68, 359, 69,
    24, 70, 322, 70, 62, 71, 280, 71, 362, 72, 21, 74, 283, 74, 323, 75, 63, 76, 365, 76,
    286, 77, 18, 78, 98, 78, 144, 78, 232, 78, 238, 78, 244, 78, 137, 79, 149, 79, 249, 79,
    321, 79, 65, 80, 154, 80, 227, 80, 254, 80, 289, 80, 367, 80, 131, 81, 159, 81, 16, 82,
    258, 82, 60, 83, 68, 83, 222, 83, 292, 83, 317, 83, 323, 83, 126, 84, 164, 84, 328, 84,
    369, 84, 56, 85, 92, 85, 262, 85, 14, 86, 123, 87, 295, 87, 331, 87, 53, 88, 265, 88,
    371, 88, 12, 90, 298, 91, 333, 91, 51, 92, 140, 92, 373, 92, 245, 93, 14, 94, 122, 94,
    301, 95, 250, 96, 334, 96, 11, 97, 52, 97, 83, 97, 372, 97, 119, 98, 131, 98, 158, 98,
    224, 98, 254, 98, 266, 98, 303, 99, 163, 100, 229, 100, 375, 100, 332, 101, 10, 102, 53, 102,
    80, 102, 141, 102, 220, 102, 260, 102, 271, 102, 115, 103, 166, 103, 232, 103, 121, 104, 264, 104,
    306, 104, 217, 105, 330, 105, 374, 105, 56, 106, 112, 106, 169, 106, 235, 106, 268, 106, 9, 107,
    273, 107, 77, 108, 147, 108, 213, 108, 308, 108, 327, 108, 59, 109, 239, 109, 110, 110, 174, 110,
    323, 110, 375, 110, 11, 111, 63, 111, 275, 111, 68, 112, 137, 112, 143, 112, 149, 112, 178, 112,
    242, 112, 248, 112, 315, 112, 154, 113, 233, 113, 253, 113, 310, 113, 131, 114, 159, 114, 182, 114,
    203, 114, 238, 114, 108, 115, 140, 115, 146, 115, 227, 115, 245, 115, 257, 115, 277, 115, 373, 115,
    10, 116, 25, 116, 135, 116, 151, 116, 163, 116, 250, 116, 358, 116, 126, 117, 156, 117, 187, 117,
    231, 117, 241, 117, 261, 117, 20, 118, 112, 118, 143, 118, 167, 118, 196, 118, 222, 118, 236, 118,
    254, 118, 274, 118, 362, 118, 13, 119, 130, 119, 160, 119, 191, 119, 367, 119, 73, 120, 106, 120,
    116, 120, 123, 120, 226, 120, 258, 120, 264, 120, 279, 120, 312, 120, 372, 120, 17, 121, 23, 121,
    164, 121, 170, 121, 219, 121, 271, 121, 127, 122, 364, 122, 69, 123, 119, 123, 223, 123, 261, 123,
    267, 123, 315, 123, 20, 124, 167, 124, 173, 124, 216, 124, 74, 125, 124, 125, 280, 125, 63, 126,
    220, 126, 264, 126, 312, 126, 318, 126, 366, 126, 170, 127, 269, 127, 323, 127, 18, 128, 70, 128,
    104, 128, 118, 128, 175, 128, 214, 128, 23, 129, 58, 129, 315, 129, 363, 129, 281, 130, 326, 130,
    54, 131, 271, 131, 331, 131, 359, 131, 27, 132, 116, 132, 32, 133, 43, 133, 49, 133, 69, 133,
    103, 133, 174, 133, 212, 133, 335, 133, 353, 133, 37, 134, 316, 134, 340, 134, 346, 134, 282, 135,
    177, 136, 271, 137, 68, 138, 102, 138, 116, 138, 258, 138, 164, 139, 212, 139, 317, 139, 283, 140,
    262, 141, 128, 142, 167, 142, 177, 142, 223, 142, 272, 142, 67, 143, 101, 143, 163, 144, 257, 144,
    265, 144, 318, 144, 170, 145, 284, 145, 125, 146, 220, 146, 261, 146, 166, 147, 65, 148, 129, 148,
    160, 148, 224, 148, 253, 148, 267, 148, 172, 149, 258, 149, 319, 149, 123, 150, 156, 150, 218, 150,
    248, 150, 263, 150, 285, 150, 163, 151, 227, 151, 100, 152, 127, 152, 133, 152, 149, 152, 168, 152,
    222, 152, 232, 152, 238, 152, 244, 152, 255, 152, 64, 153, 143, 153, 159, 153, 174, 153, 260, 153,
    266, 153, 321, 153, 121, 154, 137, 154, 153, 154, 216, 154, 250, 154, 130, 155, 165, 155, 225, 155,
    235, 155, 241, 155, 61, 156, 125, 156, 146, 156, 170, 156, 220, 156, 230, 156, 246, 156, 257, 156,
    263, 156, 269, 156, 285, 156, 324, 156, 66, 157, 134, 157, 140, 157, 156, 157, 319, 157, 119, 158,
    150, 158, 161, 158, 175, 158, 238, 158, 252, 158, 58, 159, 128, 159, 167, 159, 215, 159, 223, 159,
    233, 159, 243, 159, 260, 159, 266, 159, 123, 160, 137, 160, 143, 160, 228, 160, 248, 160, 327, 160,
    132, 161, 153, 161, 171, 161, 219, 161, 255, 161, 270, 161, 65, 162, 147, 162, 158, 162, 164, 162,
    236, 162, 263, 162, 286, 162, 320, 162, 56, 163, 99, 163, 118, 163, 126, 163, 140, 163, 225, 163,
    231, 163, 241, 163, 251, 163, 135, 164, 168, 164, 174, 164, 214, 164, 246, 164, 258, 164, 267, 164,
    329, 164, 122, 165, 130, 165, 144, 165, 150, 165, 161, 165, 221, 165, 155, 166, 228, 166, 234, 166,
    254, 166, 54, 167, 138, 167, 165, 167, 171, 167, 217, 167, 239, 167, 249, 167, 261, 167, 65, 168,
    125, 168, 133, 168, 147, 168, 224, 168, 244, 168, 269, 168, 286, 168, 320, 168, 331, 168, 118, 169,
    142, 169, 152, 169, 158, 169, 175, 169, 231, 169, 257, 169, 129, 170, 168, 170, 214, 170, 220, 170,
    236, 170, 252, 170, 264, 170, 122, 171, 136, 171, 162, 171, 241, 171, 247, 171, 52, 172, 145, 172,
    155, 172, 172, 172, 98, 173, 126, 173, 140, 173, 150, 173, 217, 173, 223, 173, 233, 173, 267, 173,
    287, 173, 321, 173, 332, 173, 65, 174, 119, 174, 159, 174, 238, 174, 244, 174, 250, 174, 169, 175,
    123, 176, 137, 176, 143, 176, 153, 176, 220, 176, 53, 177, 148, 177, 173, 177, 241, 177, 247, 177,
    265, 177, 320, 178, 333, 178, 98, 179, 287, 179, 65, 180, 122, 181, 171, 181, 263, 181, 52, 182,
    221, 182, 332, 183, 125, 184, 168, 184, 191, 184, 259, 184, 320, 184, 225, 185, 287, 185, 54, 186,
    65, 186, 98, 186, 255, 186, 129, 187, 164, 187, 229, 187, 331, 188, 135, 190, 288, 190, 319, 190,
    53, 191, 66, 191, 329, 193, 56, 194, 97, 194, 287, 195, 319, 196, 66, 197, 177, 197, 192, 197,
    207, 197, 327, 197, 58, 198, 288, 200, 324, 200, 61, 201, 209, 201, 318, 201, 67, 202, 98, 202,
    176, 202, 191, 202, 322, 204, 63, 205, 194, 205, 287, 205, 208, 206, 317, 206, 68, 207, 177, 207,
    190, 207, 98, 208, 195, 210, 179, 211, 186, 211, 204, 211, 287, 211, 316, 211, 69, 212, 199, 212,
    71, 216, 99, 216, 286, 216, 314, 216, 285, 221, 312, 221, 71, 222, 100, 223, 74, 225, 310, 225,
    284, 226, 77, 228, 101, 228, 308, 229, 283, 231, 79, 232, 102, 233, 305, 233, 82, 235, 106, 235,
    280, 235, 302, 236, 284, 237, 85, 238, 103, 238, 109, 238, 277, 238, 113, 240, 281, 240, 298, 240,
    106, 241, 273, 241, 87, 242, 116, 243, 295, 243, 91, 244, 269, 244, 276, 244, 283, 244, 104, 245,
    120, 245, 94, 247, 264, 247, 280, 247, 292, 247, 107, 248, 123, 248, 260, 249, 97, 250, 127, 250,
    288, 250, 132, 251, 256, 251, 278, 251, 137, 252, 94, 253, 100, 253, 106, 253, 142, 253, 250, 253,
    285, 253, 146, 255, 152, 255, 236, 255, 242, 255, 254, 255, 280, 255, 103, 256, 157, 256, 228, 256,
    247, 256, 108, 257, 162, 257, 222, 257, 167, 258, 173, 258, 215, 258, 232, 258, 277, 258, 178, 259,
    184, 259, 204, 259, 210, 259, 189, 260, 195, 260, 219, 260, 200, 261
];

val pipimi as int[] = [
    50, 15, 56, 15, 145, 15, 151, 15, 60, 17, 139, 17, 155, 17, 46, 18, 64, 19, 135, 20, 
    68, 21, 157, 21, 44, 22, 130, 23, 72, 24, 127, 26, 158, 26, 43, 27, 75, 27, 124, 29, 
    78, 30, 160, 30, 41, 32, 121, 32, 81, 33, 161, 35, 84, 36, 117, 36, 40, 38, 87, 40, 
    115, 40, 97, 41, 103, 41, 161, 41, 108, 42, 90, 43, 40, 44, 113, 44, 162, 46, 88, 47, 
    71, 49, 114, 49, 128, 49, 40, 50, 77, 51, 90, 51, 123, 51, 161, 51, 73, 55, 40, 56, 
    162, 56, 138, 59, 41, 61, 142, 61, 161, 61, 56, 63, 42, 66, 149, 66, 160, 66, 51, 67, 
    152, 69, 43, 71, 159, 71, 73, 73, 127, 73, 157, 75, 42, 76, 71, 77, 130, 77, 161, 78, 
    75, 79, 39, 80, 127, 80, 69, 81, 132, 81, 163, 82, 37, 84, 75, 85, 134, 85, 68, 86, 
    127, 86, 166, 86, 35, 88, 66, 90, 72, 90, 78, 90, 124, 90, 130, 90, 168, 90, 83, 91, 
    135, 91, 33, 92, 119, 92, 61, 93, 75, 93, 127, 93, 139, 93, 86, 94, 65, 95, 143, 95, 
    169, 95, 31, 96, 57, 96, 136, 96, 74, 99, 127, 99, 171, 99, 64, 100, 30, 101, 137, 101, 
    79, 103, 61, 104, 68, 104, 84, 104, 90, 104, 96, 104, 102, 104, 108, 104, 114, 104, 120, 104, 
    126, 104, 140, 104, 172, 104, 54, 105, 73, 105, 131, 105, 145, 105, 28, 106, 49, 106, 150, 106, 
    64, 107, 77, 107, 123, 107, 135, 107, 155, 107, 42, 108, 58, 108, 82, 108, 142, 108, 35, 109, 
    119, 109, 160, 109, 166, 109, 173, 109, 51, 110, 146, 110, 152, 110, 85, 111, 28, 112, 40, 112, 
    56, 112, 116, 112, 88, 114, 148, 114, 161, 114, 174, 114, 52, 115, 114, 116, 27, 117, 151, 117, 
    40, 118, 50, 119, 89, 119, 162, 119, 175, 119, 82, 120, 113, 121, 144, 121, 58, 122, 153, 122, 
    26, 123, 39, 123, 85, 123, 120, 123, 90, 124, 147, 124, 81, 125, 162, 125, 175, 125, 56, 126, 
    143, 126, 87, 127, 118, 127, 60, 128, 77, 128, 149, 128, 26, 129, 39, 129, 83, 129, 122, 129, 
    138, 129, 54, 130, 64, 130, 70, 130, 133, 130, 145, 130, 163, 130, 176, 130, 89, 131, 116, 131, 
    126, 131, 58, 132, 74, 132, 80, 132, 141, 132, 67, 133, 85, 133, 120, 133, 130, 133, 136, 133, 
    148, 133, 25, 134, 38, 134, 62, 134, 53, 135, 71, 135, 77, 135, 124, 135, 144, 135, 164, 135, 
    82, 136, 115, 136, 133, 136, 139, 136, 151, 136, 176, 136, 57, 137, 65, 137, 87, 137, 128, 137, 
    74, 138, 119, 138, 147, 138, 23, 139, 61, 139, 69, 139, 79, 139, 136, 139, 142, 139, 179, 139, 
    38, 140, 52, 140, 84, 140, 123, 140, 131, 140, 89, 141, 114, 141, 150, 141, 164, 141, 20, 142, 
    26, 142, 56, 142, 64, 142, 72, 142, 127, 142, 139, 142, 145, 142, 77, 143, 118, 143, 134, 143, 
    176, 143, 182, 143, 68, 144, 86, 144, 37, 145, 53, 145, 130, 145, 148, 145, 18, 146, 74, 146, 
    115, 146, 137, 146, 164, 147, 184, 147, 70, 148, 133, 148, 25, 149, 55, 149, 87, 149, 16, 150, 
    37, 151, 118, 151, 186, 151, 58, 152, 147, 152, 165, 152, 83, 153, 122, 154, 177, 154, 15, 155, 
    62, 155, 185, 156, 36, 157, 165, 158, 16, 160, 187, 160, 24, 161, 36, 163, 91, 163, 102, 163, 
    114, 163, 165, 164, 185, 164, 15, 165, 178, 167, 18, 168, 90, 168, 103, 168, 115, 168, 36, 169,
    184, 169, 165, 170, 100, 171, 20, 172, 92, 172, 105, 172, 113, 172, 181, 173, 96, 174, 109, 174,
    23, 175, 36, 175, 165, 176, 179, 177, 21, 179, 36, 181, 165, 182, 180, 182, 22, 184, 37, 186,
    165, 188, 180, 188, 21, 189, 37, 192, 181, 193, 165, 194, 21, 195, 37, 198, 180, 198, 164, 199,
    21, 201, 181, 203, 37, 204, 164, 205, 20, 206, 38, 209, 181, 209, 21, 211, 164, 211, 38, 215,
    181, 215, 20, 216, 163, 217, 21, 221, 38, 221, 181, 221, 162, 222, 40, 225, 20, 226, 159, 226,
    182, 226, 163, 228, 42, 229, 157, 230, 181, 231, 20, 232, 39, 232, 44, 233, 162, 233, 156, 235,
    182, 236, 40, 237, 46, 237, 20, 238, 154, 239, 162, 239, 48, 241, 181, 241, 40, 243, 151, 243,
    20, 244, 51, 244, 161, 245, 182, 246, 149, 247, 53, 248, 40, 249, 20, 250, 146, 251, 161, 251,
    180, 251, 55, 252, 41, 254, 143, 254, 58, 255, 182, 255, 20, 256, 139, 256, 62, 257, 161, 257,
    40, 259, 66, 259, 135, 259, 180, 259, 22, 260, 70, 261, 76, 261, 82, 261, 88, 261, 94, 261,
    100, 261, 106, 261, 112, 261, 118, 261, 124, 261, 130, 261, 160, 263, 41, 264, 21, 265, 179, 265,
    160, 269, 23, 270, 41, 270, 42, 275, 160, 275, 178, 275, 23, 276, 24, 281, 42, 281, 159, 281,
    178, 281, 38, 285, 161, 285, 166, 286, 24, 287, 30, 287, 171, 287, 177, 287
];

val popukoWidth = 386;
val popukoHeight = 290;
val pipimiWidth = 203;
val pipimiHeight = 304;

NetworkHandler.registerServer2ClientMessage("pop_pipi", function(player, buf) {
    val f = buf.readBoolean();
    if (f) {
        showImageByParticles(popuko, popukoWidth, popukoHeight, 0xe1ae1f, player.world.random, [player.posX, player.posY, player.posZ]);
    } else {
        showImageByParticles(pipimi, pipimiWidth, pipimiHeight, 0x464e8d, player.world.random, [player.posX, player.posY, player.posZ]);
    }
});

val now = Util.now();
val aprilFool = now.month == DateUtil.APRIL() && now.day == 1;

events.onPlayerTick(function(event as PlayerTickEvent) {
    val player = event.player;
    val world = player.world;
    if (!world.remote && aprilFool && world.random.nextInt(6000) == 401) {
        NetworkHandler.sendToDimension("pop_pipi", world.dimension, function(b) {
            b.writeBoolean(world.random.nextBoolean());
        });
    }
});
